<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>LibreCast</title>

	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

	<link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="components/fontawesome/css/font-awesome.min.css">

	<meta name="mobile-web-app-capable" content="yes">

	<style>
	#media-list, #medium-player {
		display: none;
	}
	header .actions {
		float: right;
		font-size: 20px;
		line-height: 36px;
		vertical-align: middle;
	}
	</style>
</head>
<body>
	<div id="main-container" class="container">
		<section id="channels-list">
			<header>
				<div class="actions">
					<a href="#" target="_blank" class="atom-link"><i class="fa fa-rss"></i></a>
				</div>
				<h1>LibreCast</h1>
			</header>

			<div class="list-group"></div>
		</section>

		<section id="media-list" style="display:none;">
			<header>
				<div class="actions">
					<a href="#" target="_blank" class="atom-link"><i class="fa fa-rss"></i></a>
				</div>
				<h1>
					<a href="#" class="back-link"><i class="fa fa-angle-left"></i></a>&nbsp;
					<span class="inner"></span>
				</h1>
			</header>

			<div class="list-group"></div>
		</section>

		<section id="medium-player" style="display:none;">
			<header>
				<div class="actions">
					<a href="#" target="_blank" class="download-link"><i class="fa fa-cloud-download"></i></a>
				</div>
				<h1>
					<a href="#" class="back-link"><i class="fa fa-angle-left"></i></a>&nbsp;
					<span class="inner"></span>
				</h1>
			</header>

			<div class="player-image text-center">
				<img class="img-responsive img-thumbnail">
			</div>
			<div class="player-video text-center">
				<video controls></video>
			</div>
			<div class="player-audio text-center">
				<audio controls></audio>
			</div>
			<div class="player-fallback">
				<p class="text-center">
					<a href="#" class="btn btn-primary btn-lg" target="_blank">Open media</a>
				</p>
			</div>

			<div class="player-metadata">
				<p></p>
			</div>
		</section>
	</div>

	<script src="components/jquery/dist/jquery.min.js"></script>
	<script src="components/bootstrap/dist/js/bootstrap.min.js"></script>

	<script>
	$(function () {

	var $mainContainer = $('#main-container');
	var $channels = $('#channels-list');
	var $channelsList = $channels.find('.list-group');
	var $media = $('#media-list');
	var $mediaList = $media.find('.list-group');
	var $player = $('#medium-player');
	var $imagePlayer = $player.find('.player-image img');
	var $audioPlayer = $player.find('.player-audio audio');
	var $videoPlayer = $player.find('.player-video video');
	var $fallbackPlayer = $player.find('.player-fallback');
	var $playerMetadata = $player.find('.player-metadata');

	function loadFeed(url, done) {
		var req = new XMLHttpRequest();

		req.addEventListener('load', function () {
			if (String(this.status)[0] != '2') { // Not 2xx
				done('HTTP error: '+this.status);
				return;
			}

			var xml = this.responseText;
			var parser = new DOMParser();
			var dom = parser.parseFromString(xml, "application/xml");
			done(null, dom);
		});

		req.addEventListener('error', function () {
			done('HTTP request error');
		});

		req.open('GET', url, true);
		req.send();
	}

	function parseEntryTag(entry, selector, attr) {
		var tag = entry.querySelector(selector);
		if (!tag) {
			return undefined;
		}
		if (!attr) {
			return tag.textContent;
		} else if (attr == 'innerHTML') {
			return tag.innerHTML;
		} else {
			return tag.getAttribute(attr);
		}
	}
	function parseMetadata(feed) {
		return {
			id: parseEntryTag(feed, 'id'),
			title: parseEntryTag(feed, 'title'),
			updated: parseEntryTag(feed, 'updated'),
			feed_url: parseEntryTag(feed, 'link[rel="self"]', 'href')
		};
	}
	function parseEntry(entry) {
		var item = {
			id: parseEntryTag(entry, 'id'),
			title: parseEntryTag(entry, 'title'),
			summary: parseEntryTag(entry, 'summary'),
			content: parseEntryTag(entry, 'content', 'innerHTML'),
			published: parseEntryTag(entry, 'published'),
			url: parseEntryTag(entry, 'link[rel="alternate"][type="text/html"]', 'href'),
			feed_url: parseEntryTag(entry, 'link[rel="alternate"][type="application/atom+xml"]', 'href')
		};

		var enclosures = entry.querySelectorAll('link[rel="enclosure"]');
		if (enclosures.length) {
			item.enclosures = [];
			for (var i = 0; i < enclosures.length; i++) {
				var enc = enclosures[i];
				item.enclosures.push({
					url: enc.getAttribute('href'),
					type: enc.getAttribute('type'),
					size: enc.getAttribute('length')
				});
			}
		}

		return item;
	}

	function renderChannelEntry(entry) {
		var $item = $('<a></a>', {
			href: entry.url,
			'class': 'list-group-item'
		});
		$item.append($('<h4></h4>', { 'class': 'list-group-item-heading' }).text(entry.title));
		$item.append($('<p></p>', { 'class': 'list-group-item-text' }).text(entry.summary));

		$item.click(function (event) {
			event.preventDefault();

			$(this).addClass('active');
			showChannel(entry.feed_url);
		});

		return $item;
	}

	function getEnclosureType(enclosure) {
		if (!enclosure.type) {
			return false;
		}

		if (enclosure.type.indexOf('image/') === 0) {
			return 'image';
		}
		if (enclosure.type.indexOf('audio/') === 0) {
			return 'audio';
		}
		if (enclosure.type.indexOf('video/') === 0) {
			return 'video';
		}
		if (enclosure.type == 'application/x-bittorrent') {
			return 'torrent';
		}

		return false;
	}
	function isEnclosureSupported(enclosure) {
		return (getEnclosureType(enclosure) !== false);
	}
	function openEnclosure(enclosure) {
		var type = getEnclosureType(enclosure);
		$player.children('div:not(.player-metadata)').hide();
		if ($player.find('.player-'+type).length) {
			$player.find('.player-'+type).show();
		} else {
			$player.find('.player-fallback').show();
		}
		$player.show();

		$player.find('.download-link').attr('href', enclosure.url);

		switch (getEnclosureType(enclosure)) {
			case 'image':
				$imagePlayer.attr('src', enclosure.url);
			case 'audio':
				$audioPlayer.attr('src', enclosure.url);
				break;
			case 'video':
				$videoPlayer.attr('src', enclosure.url);
				break;
			default:
				$fallbackPlayer.find('a').attr('href', enclosure.url);
				return;
		}
	}
	function openMedium(entry) {
		var enclosure = getMediumEnclosure(entry);

		switchPage('medium-player');

		$player.find('h1 .inner').text(entry.title);
		if (entry.summary) {
			$player.find('h1 .inner').append('<br>').append($('<small></small>').text(entry.summary));
		}

		$playerMetadata.find('p').html(entry.content || '');

		openEnclosure(enclosure);
	}

	function getMediumEnclosure(entry) {
		if (!entry.enclosures) {
			return;
		}

		for (var i = 0; i < entry.enclosures.length; i++) {
			var enc = entry.enclosures[i];
			if (isEnclosureSupported(enc)) {
				return enc;
			}
		}
	}
	function renderMediumEntry(entry) {
		var enclosure = getMediumEnclosure(entry);

		var icons = {
			image: 'picture-o',
			audio: 'music',
			video: 'film',
			torrent: ''
		};
		var icon = icons[getEnclosureType(enclosure)];

		var $item = $('<a></a>', {
			href: entry.url,
			target: '_blank',
			'class': 'list-group-item'
		});
		$item.append($('<h4></h4>', { 'class': 'list-group-item-heading' }).text(entry.title));
		$item.append($('<p></p>', { 'class': 'list-group-item-text' }).text(entry.summary).prepend((icon) ? '<i class="fa fa-'+icon+'"></i>&nbsp;' : ''));

		$item.click(function (event) {
			if (enclosure) {
				event.preventDefault();
				$(this).parent().children('.active').removeClass('active');
				$(this).addClass('active');
				openMedium(entry);
			}
		});

		return $item;
	}

	function showChannel(feedUrl) {
		$mediaList.empty();

		switchPage('media-list');

		loadFeed(feedUrl, function (err, dom) {
			if (err) return alert('Could not load channel: ' + err);

			var feed = dom.firstChild;

			var metadata = parseMetadata(feed);
			$media.find('h1 .inner').text(metadata.title);
			$media.find('.atom-link').attr('href', metadata.feed_url);

			var entries = feed.querySelectorAll('entry');
			for (var i = 0; i < entries.length; i++) {
				var entry = parseEntry(entries[i]);
				var $item = renderMediumEntry(entry);
				$mediaList.append($item);
			}
		});
	}

	function switchPage(newPage) {
		$mainContainer.children().hide();
		$mainContainer.children('#'+newPage).show();
	}

	// Setup events
	$media.find('.back-link').click(function (event) {
		event.preventDefault();
		switchPage('channels-list');
	});
	$player.find('.back-link').click(function (event) {
		event.preventDefault();
		switchPage('media-list');
	});

	// Load channels feed
	var channelsFeed = '../atom.xml';

	$channelsList.empty();

	loadFeed(channelsFeed, function (err, dom) {
		if (err) return alert('Could not load channels list: ' + err);

		var feed = dom.firstChild;

		var metadata = parseMetadata(feed);
		$channels.find('.atom-link').attr('href', metadata.feed_url);

		var entries = feed.querySelectorAll('entry');
		for (var i = 0; i < entries.length; i++) {
			var entry = parseEntry(entries[i]);

			var $item = renderChannelEntry(entry);
			$channelsList.append($item);
		}
	});

	});
	</script>
</body>
</html>