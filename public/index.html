<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>LibreCast</title>

	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

	<link rel="stylesheet" href="components/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="components/fontawesome/css/font-awesome.min.css">

	<meta name="mobile-web-app-capable" content="yes">

	<style>
	#media-list, #medium-player {
		display: none;
	}
	header .actions {
		float: right;
		font-size: 20px;
		line-height: 36px;
		vertical-align: middle;
	}
	</style>
</head>
<body>
	<div id="main-container" class="container">
		<section id="channels-list">
			<header>
				<div class="actions">
					<a href="#" target="_blank" class="atom-link"><i class="fa fa-rss"></i></a>
				</div>
				<h1>LibreCast</h1>
			</header>

			<div class="list-group"></div>
		</section>

		<section id="media-list" style="display:none;">
			<header>
				<div class="actions">
					<a href="#" target="_blank" class="atom-link"><i class="fa fa-rss"></i></a>
				</div>
				<h1>
					<a href="#" class="back-link"><i class="fa fa-angle-left"></i></a>&nbsp;
					<span class="inner"></span>
				</h1>
			</header>

			<div class="list-group"></div>
		</section>

		<section id="medium-player" style="display:none;">
			<header>
				<div class="actions">
					<a href="#" target="_blank" class="download-link"><i class="fa fa-cloud-download"></i></a>
				</div>
				<h1>
					<a href="#" class="back-link"><i class="fa fa-angle-left"></i></a>&nbsp;
					<span class="inner"></span>
				</h1>
			</header>

			<div class="player-image text-center">
				<img class="img-responsive img-thumbnail">
			</div>
			<div class="player-audio text-center">
				<audio controls></audio>
			</div>
			<div class="player-video text-center">
				<video controls></video>
			</div>
			<div class="player-youtube text-center embed-responsive embed-responsive-16by9">
				<iframe class="embed-responsive-item" frameborder="0"></iframe>
			</div>
			<div class="player-fallback">
				<p class="text-center">
					<a href="#" class="btn btn-primary btn-lg" target="_blank">Open media</a>
				</p>
			</div>

			<div class="player-metadata">
				<br><br>
				<div class="player-description"></div>
			</div>
		</section>
	</div>

	<script src="components/jquery/dist/jquery.min.js"></script>
	<script src="components/bootstrap/dist/js/bootstrap.min.js"></script>

	<script>
	$(function () {

	function parseEntryTag(entry, selector, attr) {
		var tag = entry.querySelector(selector);
		if (!tag) {
			return undefined;
		}
		if (!attr) {
			return tag.textContent;
		} else if (attr == 'innerHTML') {
			return tag.innerHTML;
		} else {
			return tag.getAttribute(attr);
		}
	}
	function parseDateTag(entry, selector, attr) {
		var val = parseEntryTag(entry, selector, attr);
		if (val) {
			return new Date(val);
		}
	}

	function Feed() {
		this.type = '';
		this.title = '';
		this.updated = '';
		this.url = '';

		this.items = [];
	}

	function AtomFeed() {
		Feed.call(this);
	}
	AtomFeed.prototype.parseEntry = function (entry) {
		var item = {
			id: parseEntryTag(entry, 'id'),
			title: parseEntryTag(entry, 'title'),
			summary: parseEntryTag(entry, 'summary'),
			published: parseDateTag(entry, 'published'),
			url: parseEntryTag(entry, 'link[rel="alternate"][type="text/html"], link:not([rel]):not([type])', 'href'),
			rss_url: parseEntryTag(entry, 'link[rel="alternate"][type="application/rss+xml"]', 'href'),
			atom_url: parseEntryTag(entry, 'link[rel="alternate"][type="application/atom+xml"]', 'href')
		};

		var contentTag = entry.querySelector('content');
		if (contentTag) {
			if (contentTag.firstElementChild) {
				item.content = contentTag.innerHTML;
			} else {
				item.content = contentTag.textContent;
			}
		}

		var enclosures = entry.querySelectorAll('link[rel="enclosure"]');
		if (enclosures.length) {
			item.enclosures = [];
			for (var i = 0; i < enclosures.length; i++) {
				var enc = enclosures[i];
				item.enclosures.push({
					url: enc.getAttribute('href'),
					type: enc.getAttribute('type'),
					size: enc.getAttribute('length')
				});
			}
		}

		return item;
	};
	AtomFeed.prototype.parseFeed = function (feed) {
		this.id = parseEntryTag(feed, 'id');
		this.title = parseEntryTag(feed, 'title');
		this.updated = parseEntryTag(feed, 'updated');
		this.atom_url = parseEntryTag(feed, 'link[rel="self"]', 'href');

		var entries = feed.querySelectorAll('entry');
		for (var i = 0; i < entries.length; i++) {
			this.items.push(this.parseEntry(entries[i]));
		}
	};
	AtomFeed.prototype.parse = function (dom) {
		this.parseFeed(dom.firstChild);
	};

	function RssFeed() {
		Feed.call(this);
	}
	RssFeed.prototype.parseEntry = function (entry) {
		var item = {
			title: parseEntryTag(entry, 'title'),
			summary: parseEntryTag(entry, 'description'),
			published: parseDateTag(entry, 'pubDate'),
			url: parseEntryTag(entry, 'link')
		};

		var enclosures = entry.querySelectorAll('enclosure');
		if (enclosures.length) {
			item.enclosures = [];
			for (var i = 0; i < enclosures.length; i++) {
				var enc = enclosures[i];
				item.enclosures.push({
					url: enc.getAttribute('url'),
					type: enc.getAttribute('type'),
					size: enc.getAttribute('length')
				});
			}
		}

		return item;
	};
	RssFeed.prototype.parseFeed = function (feed) {
		this.title = parseEntryTag(feed, 'title');
		this.updated = parseEntryTag(feed, 'lastBuildDate');
		this.url = parseEntryTag(feed, 'link');

		var entries = feed.querySelectorAll('item');
		for (var i = 0; i < entries.length; i++) {
			this.items.push(this.parseEntry(entries[i]));
		}
	};
	RssFeed.prototype.parse = function (dom) {
		this.parseFeed(dom.firstChild);
	};

	var serverUrl = '..';

	var $mainContainer = $('#main-container');
	var $channels = $('#channels-list');
	var $channelsList = $channels.find('.list-group');
	var $media = $('#media-list');
	var $mediaList = $media.find('.list-group');
	var $player = $('#medium-player');
	var $imagePlayer = $player.find('.player-image img');
	var $audioPlayer = $player.find('.player-audio audio');
	var $videoPlayer = $player.find('.player-video video');
	var $youtubePlayer = $player.find('.player-youtube iframe');
	var $fallbackPlayer = $player.find('.player-fallback');
	var $playerMetadata = $player.find('.player-metadata');

	function loadFeed(url, done) {
		// Proxy requests if needed
		var parser = document.createElement('a');
		parser.href = url;
		if (parser.origin != window.location.origin) {
			url = 'feed?url='+encodeURIComponent(url);
		}

		var req = new XMLHttpRequest();

		req.addEventListener('load', function () {
			if (String(this.status)[0] != '2') { // Not 2xx
				done('HTTP error: '+this.status);
				return;
			}

			var xml = this.responseText;
			var parser = new DOMParser();
			var dom = parser.parseFromString(xml, 'application/xml');

			var feedType = req.getResponseHeader('Content-Type').split(';')[0];
			var feed;
			if (feedType == 'text/xml' || feedType == 'application/xml') {
				var tagName = dom.firstChild.nodeName.toLowerCase();
				if (tagName == 'rss') {
					feedType = 'application/rss+xml';
				}
				if (tagName == 'feed') {
					feedType = 'application/atom+xml';
				}
			}
			if (feedType == 'application/rss+xml') {
				feed = new RssFeed();
			}
			if (feedType == 'application/atom+xml') {
				feed = new AtomFeed();
			}
			if (!feed) {
				return done('Unknown feed type: '+feedType);
			}
			feed.parse(dom);
			done(null, feed);
		});

		req.addEventListener('error', function () {
			done('HTTP request error');
		});

		req.open('GET', url, true);
		req.send();
	}

	function renderChannelEntry(entry) {
		var $item = $('<a></a>', {
			href: entry.url,
			'class': 'list-group-item'
		});
		if (entry.published) {
			$item.append($('<span></span>', { 'class': 'pull-right text-muted' }).text(entry.published.toLocaleString()));
		}
		$item.append($('<h4></h4>', { 'class': 'list-group-item-heading' }).text(entry.title));
		$item.append($('<p></p>', { 'class': 'list-group-item-text' }).text(entry.summary));

		$item.click(function (event) {
			event.preventDefault();

			//$(this).parent().children('.active').removeClass('active');
			//$(this).addClass('active');
			showChannel(entry.atom_url || entry.rss_url);
		});

		return $item;
	}

	function getEnclosureType(enclosure) {
		if (!enclosure || !enclosure.type) {
			return false;
		}

		if (enclosure.type.indexOf('image/') === 0) {
			return 'image';
		}
		if (enclosure.type.indexOf('audio/') === 0) {
			return 'audio';
		}
		if (enclosure.type.indexOf('video/') === 0) {
			return 'video';
		}
		if (enclosure.type == 'application/x-bittorrent') {
			return 'torrent';
		}
		if (enclosure.type == 'text/html') {
			var parser = document.createElement('a');
			parser.href = enclosure.url;
			if (parser.hostname == 'www.youtube.com' && parser.pathname == '/watch') {
				return 'youtube';
			}
		}

		return false;
	}
	function isEnclosureSupported(enclosure) {
		return (getEnclosureType(enclosure) !== false);
	}
	function openEnclosure(enclosure) {
		var type = getEnclosureType(enclosure);
		$player.children('div:not(.player-metadata)').hide();
		if ($player.find('.player-'+type).length) {
			$player.find('.player-'+type).show();
		} else {
			$player.find('.player-fallback').show();
		}
		$player.show();

		$player.find('.download-link').attr('href', enclosure.url);

		switch (getEnclosureType(enclosure)) {
			case 'image':
				$imagePlayer.attr('src', enclosure.url);
			case 'audio':
				$audioPlayer.attr('src', enclosure.url);
				break;
			case 'video':
				$videoPlayer.attr('src', enclosure.url);
				break;
			case 'youtube':
				var parser = document.createElement('a');
				parser.href = enclosure.url;
				var videoId = parser.searchParams.get('v');
				if (videoId) {
					$youtubePlayer.attr('src', '//www.youtube.com/embed/'+videoId);
				}
				break;
			default:
				$fallbackPlayer.find('a').attr('href', enclosure.url);
				return;
		}
	}
	function openMedium(entry) {
		var enclosure = getMediumEnclosure(entry);

		switchPage('medium-player');

		$player.find('h1 .inner').text(entry.title);
		if (entry.summary) {
			$player.find('h1 .inner').append('<br>').append($('<small></small>').text(entry.summary));
		}

		$playerMetadata.find('.player-description').html(entry.content || '');

		openEnclosure(enclosure);
	}

	function getMediumEnclosure(entry) {
		if (!entry.enclosures) {
			return;
		}

		for (var i = 0; i < entry.enclosures.length; i++) {
			var enc = entry.enclosures[i];
			if (isEnclosureSupported(enc)) {
				return enc;
			}
		}
	}
	function renderMediumEntry(entry) {
		var enclosure = getMediumEnclosure(entry);

		if (!enclosure && entry.url && entry.url.indexOf('http://www.youtube.com/watch') === 0) {
			enclosure = {
				url: entry.url,
				type: 'text/html'
			};
			entry.enclosures = [enclosure];
		}

		var icons = {
			image: 'picture-o',
			audio: 'music',
			video: 'film',
			youtube: 'youtube-play',
			torrent: ''
		};
		var icon = icons[getEnclosureType(enclosure)];

		var $item = $('<a></a>', {
			href: entry.url,
			target: '_blank',
			'class': 'list-group-item'
		});
		if (entry.published) {
			$item.append($('<span></span>', { 'class': 'pull-right text-muted' }).text(entry.published.toLocaleString()));
		}
		
		$item.append($('<h4></h4>', { 'class': 'list-group-item-heading' }).text(entry.title));
		$item.append($('<p></p>', { 'class': 'list-group-item-text' }).text(entry.summary).prepend((icon) ? '<i class="fa fa-'+icon+'"></i>&nbsp;' : ''));

		$item.click(function (event) {
			if (enclosure) {
				event.preventDefault();

				//$(this).parent().children('.active').removeClass('active');
				//$(this).addClass('active');
				openMedium(entry);
			}
		});

		return $item;
	}

	function showChannel(feedUrl) {
		$mediaList.empty();

		loadFeed(feedUrl, function (err, feed) {
			if (err) return alert('Could not load channel: ' + err);

			switchPage('media-list');

			if (!feed.atom_url) {
				feed.atom_url = feedUrl;
			}
			$media.find('h1 .inner').text(feed.title);
			$media.find('.atom-link').attr('href', feed.atom_url);

			for (var i = 0; i < feed.items.length; i++) {
				var entry = feed.items[i];

				var $item = renderMediumEntry(entry);
				$mediaList.append($item);
			}
		});
	}

	function switchPage(newPage) {
		$mainContainer.children().hide();
		$mainContainer.children('#'+newPage).show();
	}

	// Setup events
	$media.find('.back-link').click(function (event) {
		event.preventDefault();
		switchPage('channels-list');
	});
	$player.find('.back-link').click(function (event) {
		event.preventDefault();
		switchPage('media-list');
	});

	// Load channels feed
	var channelsFeed = serverUrl+'/atom.xml';

	$channelsList.empty();

	loadFeed(channelsFeed, function (err, feed) {
		if (err) return alert('Could not load channels list: ' + err);

		$channels.find('.atom-link').attr('href', feed.atom_url);

		for (var i = 0; i < feed.items.length; i++) {
			var entry = feed.items[i];

			var $item = renderChannelEntry(entry);
			$channelsList.append($item);
		}
	});

	});
	</script>
</body>
</html>